(()=>{"use strict";class t{static frequencyLookup={c:261.63,"c#":277.18,d:293.66,"d#":311.13,e:329.63,f:349.23,"f#":369.99,g:392,"g#":415.3,a:440,"a#":466.16,b:493.88};constructor(e,a){this.note=e,this.octave=a;const i=t.frequencyLookup[e.toLowerCase()];if(!i)throw new Error(`that note (${e}) does not exist, only sharps are accepted`);this.frequency=i*Math.pow(2,a)}static NoteFromFequency(){Object.values(t.frequencyLookup).filter()}}class e{constructor(t,e){if(this.steps=t,this.startingNote=e,!e.note||!e.frequency||!e.octave)throw new Error("Make sure to pass a note object to the scale constructor")}getNoteAtScaleStep(e){const a=Math.floor(e/this.steps.length)+this.startingNote.octave,i=this.steps[e%this.steps.length],s=(Object.keys(t.frequencyLookup).indexOf(this.startingNote.note)+i)%12,[o]=Object.entries(t.frequencyLookup)[s];if(!o)throw new Error(`could not get note ${this.startingNote} in ${Object.keys(t.frequencyLookup)}`);return new t(o,a)}}const a=[10,90],i=[0,16],s=[0,12],o=["square","sawtooth"],h=(t,[e,a])=>t<e?e:t>a?a:t;class r{constructor({stemHeight:t,petalCurve:e,petalWidth:a,petalHeight:i,petalColor:s,petalCount:o,headScalePattern:h,scale:r,petalOffset:n,waveType:l}){this.stemHeight=t,this.petalCurve=e,this.petalWidth=a,this.petalHeight=i,this.petalColor=s,this.petalCount=o,this.petalOffset=n,this.waveType=l,this.headScalePattern=h,this.scale=r}static getSerialization(){}static MergeFlowerData(t,e){}static RandomFlowerData(){return console.log(o),new r({stemHeight:h(Math.floor(Math.random()*s[1]),s),petalCurve:1*Math.random(),petalWidth:h(Math.random()*a[1]+20,a),petalHeight:200*Math.random()+100,petalColor:[Math.floor(255*Math.random()),Math.floor(255*Math.random()),Math.floor(255*Math.random())],petalCount:[2,4,8,16][Math.floor(4*Math.random())],headScalePattern:[0],scale:(n=new t("f",-1),new e([0,4,7],n)),petalOffset:h(17*Math.random(),i),waveType:o[Math.floor(o.length*Math.random())]});var n}}class n{constructor(t,e,a){this.state=a,this.data=e,this.ctx=t}draw(){const t=window.innerHeight-(30*this.data.stemHeight+100);this.ctx.translate(this.state.position,t),this.drawStem(10,t),this.drawHead(),this.drawPetals(),this.ctx.translate(-1*this.state.position,-1*t)}drawStem(t,e){this.ctx.fillStyle="#73ba8d",this.ctx.fillRect(-.5*t,0,t,flowerCanvas.height-e)}drawPetals(){var t=Math.PI/180;const e=t*(360/i[1]*this.data.petalOffset);this.ctx.rotate(e);for(var a=0;a<this.data.petalCount;a++){const e=a==this.state.currentStep&&this.state.isPlaying,i=this.data.petalColor,s=`#${i[0].toString(16)}${i[1].toString(16)}${i[2].toString(16)}`,h=e?s:s+"88";this.ctx.fillStyle=h,this.ctx.beginPath(),this.ctx.moveTo(0,0),console.log({wave:this.data.waveType}),o[1]==this.data.waveType?(this.ctx.bezierCurveTo(this.data.petalCurve*this.data.petalHeight,this.data.petalWidth,this.data.petalCurve*this.data.petalHeight,this.data.petalWidth,this.data.petalHeight,0),this.ctx.moveTo(0,0),this.ctx.bezierCurveTo(this.data.petalCurve*this.data.petalHeight,-1*this.data.petalWidth,this.data.petalCurve*this.data.petalHeight,this.data.petalWidth,this.data.petalHeight,0)):(this.ctx.quadraticCurveTo(this.data.petalCurve*this.data.petalHeight,this.data.petalWidth,this.data.petalHeight,0),this.ctx.moveTo(0,0),this.ctx.quadraticCurveTo(this.data.petalCurve*this.data.petalHeight,-1*this.data.petalWidth,this.data.petalHeight,0)),this.ctx.fill(),this.ctx.rotate(t*(360/this.data.petalCount))}this.ctx.rotate(t*(360-360/this.data.petalCount*a)),this.ctx.rotate(-1*e)}drawHead(){this.ctx.fillStyle="#fced7e",this.ctx.beginPath(),this.ctx.arc(0,0,15,0,2*Math.PI),this.ctx.fill()}}class l{constructor({currentStep:t,position:e}){this.currentStep=t||0,this.receivedBeats=0,this.position=e||0,this.isPlaying=!1}reset(){this.currentStep=0,this.receivedBeats=0}}class c{constructor(t,e,a){this.state=a,this.data=e,this.audioCtx=t,this.amount=Math.random()<.5?.5:1}destroy(){this.stopCurrentNote()}playCurrentNote(){const t=this.data.scale.getNoteAtScaleStep(this.data.stemHeight);if(!this.state.isPlaying&&Math.random()<this.amount){this.oscillator=new OscillatorNode(this.audioCtx,{type:this.data.waveType,frequency:t.frequency}),this.filter=new BiquadFilterNode(this.audioCtx,{frequency:200,Q:1});const e=this.data.petalCount<16?Math.floor(this.data.petalWidth/10):Math.floor(4*Math.random());this.filter.frequency.setTargetAtTime(1e3,this.audioCtx.currentTime,e),this.oscillator.connect(this.filter).connect(this.audioCtx.destination),this.oscillator.start(),this.state.isPlaying=!0}}stopCurrentNote(){this.state.isPlaying&&(this.oscillator.stop(),this.oscillator.disconnect(),this.oscillator=null,this.state.isPlaying=!1)}}class d{constructor(t,e){this.state=new l({position:500+400*Math.random()-400*Math.random()}),this.data=r.RandomFlowerData(),this.visualizer=new n(t,this.data,this.state),this.audio=new c(e,this.data,this.state)}beatUpdate(){const t=Math.floor(64/this.data.petalCount);0===this.state.receivedBeats&&this.audio.playCurrentNote(),this.state.receivedBeats===Math.floor(64/this.data.petalCount)-2&&this.audio.stopCurrentNote(),this.state.receivedBeats+=1,this.state.receivedBeats===t&&(this.state.receivedBeats=0,this.state.currentStep=(this.state.currentStep+1)%this.data.petalCount)}destroy(){this.audio.destroy()}}let u,p,f={},w=!1;function g(t=!0){const e=new d(u,p),a=e.data.stemHeight%4;if(f[a]){if(f[a].length>=(a<2?1:3)){if(!t)return void console.warn("flower not added too many similiar notes");f[a].splice(0,1)}f[a].push(e)}else f[a]=[e]}function v(){return Object.values(f).reduce(((t,e)=>[...t,...e]),[])}window.onload=function(){window.onclick=()=>{if(console.log("clicked"),w){v().forEach((t=>{t.destroy()})),f={};const t=Math.floor(5*Math.random())+1;for(let e=0;e<=t;e++)g(!0)}else!function(){const t=window.AudioContext||window.webkitAudioContext;p=new t;const e=document.getElementById("flowerCanvas");if(!e)throw new Error("could not find flower Canvas");if(u=e.getContext("2d"),!e)throw new Error("could not get context");g(),m(),window.onresize=function(t){m()};window.setInterval((()=>{C++,32==C&&(C=0),v().forEach((t=>{t.beatUpdate()}))}),31.25),window.setInterval((()=>{}),16),window.setInterval((()=>{y(u)}),16),y(u)}(),w=!0}};let C=0;function y(t){!function(t){t.fillStyle="#dde0cc",t.fillRect(0,0,flowerCanvas.width,flowerCanvas.height)}(t),v().forEach((t=>{t.visualizer.draw()}))}function m(){const t=document.getElementById("flowerCanvas"),e=window.innerHeight,a=window.innerWidth;t.setAttribute("width",a),t.setAttribute("height",e)}})();