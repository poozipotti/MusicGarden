(()=>{"use strict";class t{static frequencyLookup={c:261.63,"c#":277.18,d:293.66,"d#":311.13,e:329.63,f:349.23,"f#":369.99,g:392,"g#":415.3,a:440,"a#":466.16,b:493.88};constructor(e,a){this.note=e,this.octave=a;const i=t.frequencyLookup[e.toLowerCase()];if(!i)throw new Error(`that note (${e}) does not exist, only sharps are accepted`);this.frequency=i*Math.pow(2,a)}static NoteFromFequency(){Object.values(t.frequencyLookup).filter()}}class e{constructor(t,e){if(this.steps=t,this.startingNote=e,!e.note||!e.frequency||!e.octave)throw new Error("Make sure to pass a note object to the scale constructor")}getNoteAtScaleStep(e){const a=Math.floor(e/this.steps.length)+this.startingNote.octave,i=this.steps[e%this.steps.length],s=(Object.keys(t.frequencyLookup).indexOf(this.startingNote.note)+i)%12,[o]=Object.entries(t.frequencyLookup)[s];if(!o)throw new Error(`could not get note ${this.startingNote} in ${Object.keys(t.frequencyLookup)}`);return new t(o,a)}}const a=[10,90],i=[0,16],s=[0,12],o=["square","sawtooth"],n=[-1,1],h=[2,2,2,4,4,4,4,4,8,8,8,16,16,32],r=(t,[e,a])=>t<e?e:t>a?a:t;class l{constructor({stemHeight:t,petalCurve:e,petalWidth:a,petalHeight:i,petalColor:s,petalCount:o,headScalePattern:n,scale:h,petalOffset:r,waveType:l,panning:d}){this.stemHeight=t,this.petalCurve=e,this.petalWidth=a,this.petalHeight=i,this.petalColor=s,this.petalCount=o,this.petalOffset=r,this.waveType=l,this.panning=d,this.headScalePattern=n,this.scale=h}static getSerialization(){}static MergeFlowerData(t,e){}static RandomFlowerData(){return new l({stemHeight:r(Math.floor(Math.random()*s[1]),s),petalCurve:1*Math.random(),petalWidth:r(Math.random()*a[1]+20,a),petalHeight:200*Math.random()+100,petalColor:[Math.floor(255*Math.random()),Math.floor(255*Math.random()),Math.floor(255*Math.random())],petalCount:h[Math.floor(Math.random()*h.length)],headScalePattern:[0],scale:(d=new t("a",-1),new e([0,2,4,6,7,9,11],d)),petalOffset:r(17*Math.random(),i),waveType:o[Math.floor(o.length*Math.random())],panning:r(2*Math.random()-1,n)});var d}}class d{constructor(t,e,a){this.state=a,this.data=e,this.ctx=t}draw(){const t=window.innerHeight-(70*this.data.stemHeight+100),e=window.innerWidth/2+this.data.panning*window.innerWidth/2;console.log(this.data.panning),this.ctx.translate(e,t),this.drawStem(10,t),this.drawHead(),this.drawPetals(),this.ctx.translate(-1*e,-1*t)}drawStem(t,e){this.ctx.fillStyle="#73ba8d",this.ctx.fillRect(-.5*t,0,t,flowerCanvas.height-e)}drawPetals(){var t=Math.PI/180;const e=t*(360/i[1]*this.data.petalOffset);this.ctx.rotate(e);for(var a=0;a<this.data.petalCount;a++){const e=a==this.state.currentStep&&this.state.isPlaying,i=this.data.petalColor,s=`#${i[0].toString(16)}${i[1].toString(16)}${i[2].toString(16)}`,n=e?s:s+"88";this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.moveTo(0,0),o[1]==this.data.waveType?(this.ctx.bezierCurveTo(this.data.petalCurve*this.data.petalHeight,this.data.petalWidth,this.data.petalCurve*this.data.petalHeight,this.data.petalWidth,this.data.petalHeight,0),this.ctx.moveTo(0,0),this.ctx.bezierCurveTo(this.data.petalCurve*this.data.petalHeight,-1*this.data.petalWidth,this.data.petalCurve*this.data.petalHeight,this.data.petalWidth,this.data.petalHeight,0)):(this.ctx.quadraticCurveTo(this.data.petalCurve*this.data.petalHeight,this.data.petalWidth,this.data.petalHeight,0),this.ctx.moveTo(0,0),this.ctx.quadraticCurveTo(this.data.petalCurve*this.data.petalHeight,-1*this.data.petalWidth,this.data.petalHeight,0)),this.ctx.fill(),this.ctx.rotate(t*(360/this.data.petalCount))}this.ctx.rotate(t*(360-360/this.data.petalCount*a)),this.ctx.rotate(-1*e)}drawHead(){this.ctx.fillStyle="#fced7e",this.ctx.beginPath(),this.ctx.arc(0,0,15,0,2*Math.PI),this.ctx.fill()}}class c{constructor({currentStep:t,position:e}){this.currentStep=t||0,this.receivedBeats=0,this.position=e||0,this.isPlaying=!1}reset(){this.currentStep=0,this.receivedBeats=0}}class u{constructor(t,e,a){this.state=a,this.data=e,this.audioCtx=t,this.amount=Math.random()<.5?.5:1}destroy(){this.stopCurrentNote()}playCurrentNote(){const t=this.data.scale.getNoteAtScaleStep(this.data.stemHeight);if(!this.state.isPlaying&&Math.random()<this.amount){this.oscillator=new OscillatorNode(this.audioCtx,{type:this.data.waveType,frequency:t.frequency}),this.filter=new BiquadFilterNode(this.audioCtx,{frequency:200,Q:1}),this.panning=new StereoPannerNode(this.audioCtx,{pan:this.data.panning});const e=this.data.petalCount<16?Math.floor(this.data.petalWidth/10):Math.floor(4*Math.random());this.filter.frequency.setTargetAtTime(1e3,this.audioCtx.currentTime,e),this.oscillator.connect(this.filter).connect(this.audioCtx.destination),this.oscillator.start(),this.state.isPlaying=!0}}stopCurrentNote(){this.state.isPlaying&&(this.oscillator.stop(),this.oscillator.disconnect(),this.oscillator=null,this.state.isPlaying=!1)}}class p{constructor(t,e){this.state=new c({position:500+400*Math.random()-400*Math.random()}),this.data=l.RandomFlowerData(),this.visualizer=new d(t,this.data,this.state),this.audio=new u(e,this.data,this.state)}beatUpdate(){const t=Math.floor(128/this.data.petalCount);0===this.state.receivedBeats&&this.audio.playCurrentNote(),this.state.receivedBeats===Math.floor(128/this.data.petalCount)-2&&this.audio.stopCurrentNote(),this.state.receivedBeats+=1,this.state.receivedBeats===t&&(this.state.receivedBeats=0,this.state.currentStep=(this.state.currentStep+1)%this.data.petalCount)}destroy(){this.audio.destroy()}}let f,w,g={},v=!1;function C(t=!0){const e=new p(f,w),a=e.data.stemHeight%4;if(g[a]){if(g[a].length>=(a<2?1:3)){if(!t)return void console.warn("flower not added too many similiar notes");g[a].splice(0,1)}g[a].push(e)}else g[a]=[e]}function m(){return Object.values(g).reduce(((t,e)=>[...t,...e]),[])}window.onload=function(){window.onclick=()=>{if(console.log("clicked"),v){m().forEach((t=>{t.destroy()})),g={};const t=Math.floor(5*Math.random())+1;for(let e=0;e<=t;e++)C(!0)}else!function(){const t=window.AudioContext||window.webkitAudioContext;w=new t;const e=document.getElementById("flowerCanvas");if(!e)throw new Error("could not find flower Canvas");if(f=e.getContext("2d"),!e)throw new Error("could not get context");C(),M(),window.onresize=function(t){M()};window.setInterval((()=>{y++,32==y&&(y=0),m().forEach((t=>{t.beatUpdate()}))}),31.25),window.setInterval((()=>{}),16),window.setInterval((()=>{x(f)}),16),x(f)}(),v=!0}};let y=0;function x(t){!function(t){t.fillStyle="#dde0cc",t.fillRect(0,0,flowerCanvas.width,flowerCanvas.height)}(t),m().forEach((t=>{t.visualizer.draw()}))}function M(){const t=document.getElementById("flowerCanvas"),e=window.innerHeight,a=window.innerWidth;t.setAttribute("width",a),t.setAttribute("height",e)}})();